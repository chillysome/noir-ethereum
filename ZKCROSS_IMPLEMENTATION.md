# zkCross åè®®å®ç°æ€»ç»“

åŸºäº zkCross è®ºæ–‡ï¼ˆFigure 7 & 8ï¼‰çš„å®ç°

## ğŸ“ åè®®æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Circuit Î›Î¨ (Figure 8)                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                             â”‚
â”‚  Setup: ç”Ÿæˆ (pkÎ¨, vkÎ¨)                â”‚
â”‚                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ 1. AF (Auditing Function)       â”‚   â”‚
â”‚  â”‚     - æ£€æŸ¥å‘é€è€…åœ°å€æ˜¯å¦åœ¨é»‘åå•   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                  â”‚                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ 2. SVF (Signature Verif)       â”‚   â”‚
â”‚  â”‚     - éªŒè¯äº¤æ˜“ç­¾åæ­£ç¡®æ€§          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                  â”‚                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ 3. STF (State Transition)       â”‚   â”‚
â”‚  â”‚     - éªŒè¯ State_old â†’ State_new    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                  â”‚                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ 4. RVF (Root Verification)       â”‚   â”‚
â”‚  â”‚     - éªŒè¯çŠ¶æ€æ ¹ä¸é“¾ä¸ŠåŒºå—ä¸€è‡´    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                  â”‚                           â”‚
â”‚            ç”Ÿæˆ ZK-Proof                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ çŠ¶æ€è½¬ç§»ç¤ºä¾‹ (Figure 7)

```
Block I-2                          Block I-3
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
State_old = {a, b, c, d, e}  â”€â”€n ç¬”äº¤æ˜“â”€â”€>  State_new = {a', b', c', d', e''}

å…¶ä¸­ï¼š
- a, b, c, d, e æ˜¯æ—§åŒºå—ä¸­çš„è´¦æˆ·çŠ¶æ€
- a', b', c', d', e'' æ˜¯æ–°åŒºå—ä¸­çš„è´¦æˆ·çŠ¶æ€
- n ç¬”äº¤æ˜“å¯¼è‡´çŠ¶æ€è½¬ç§»
```

## ğŸ“‹ å„ç»„ä»¶å®ç°

### 1. AF (Auditing Function) - å®¡è®¡åŠŸèƒ½

**åŠŸèƒ½**ï¼šæ£€æŸ¥å‘é€è€…åœ°å€æ˜¯å¦åœ¨é»‘åå•ä¸­

**æ–‡ä»¶**ï¼š`zkcross/lib/src/af.nr`

**éªŒè¯é€»è¾‘**ï¼š
```noir
pub fn audit_address(
    blacklist: Blacklist,
    address: Address,
) -> bool {
    // æ£€æŸ¥åœ°å€æ˜¯å¦åœ¨é»‘åå•ä¸­
    // å¦‚æœå­˜åœ¨ï¼Œåˆ™æ‹’ç»äº¤æ˜“
}
```

### 2. SVF (Signature Verification Function) - ç­¾åéªŒè¯

**åŠŸèƒ½**ï¼šéªŒè¯äº¤æ˜“ç­¾åçš„æ­£ç¡®æ€§

**æ–‡ä»¶**ï¼š`zkcross/lib/src/svf.nr`

**éªŒè¯é€»è¾‘**ï¼š
```noir
pub fn verify_transaction_signature(
    tx: Transaction,
    signature: Signature,
    public_key: PublicKey,
) -> bool {
    // ä½¿ç”¨ä»¥å¤ªåŠæ¤­åœ†æ›²çº¿éªŒè¯ç­¾å
    // ç¡®ä¿äº¤æ˜“ç”±ç§é’¥æŒæœ‰è€…å‘é€
}
```

### 3. STF (State Transition Function) - çŠ¶æ€è½¬ç§»å‡½æ•° â­

**åŠŸèƒ½**ï¼šéªŒè¯ State_old â†’ State_new çš„çŠ¶æ€è½¬ç§»æ­£ç¡®æ€§

**æ–‡ä»¶**ï¼š`zkcross/lib/src/stf_paper.nr`

**éªŒè¯è§„åˆ™**ï¼š
1. âœ… æ‰¾åˆ°å‘é€è€…å’Œæ¥æ”¶è€…è´¦æˆ·
2. âœ… å‘é€è€…ä½™é¢å‡å°‘ (balance -= tx.value)
3. âœ… æ¥æ”¶è€…ä½™é¢å¢åŠ  (balance += tx.value)
4. âœ… å‘é€è€… nonce é€’å¢ (nonce += 1)
5. âœ… æ¥æ”¶è€… nonce ä¸å˜
6. âœ… å…¶ä»–è´¦æˆ·ä¿æŒä¸å˜

**æ ¸å¿ƒå‡½æ•°**ï¼š
```noir
// éªŒè¯å•ç¬”äº¤æ˜“çš„çŠ¶æ€è½¬ç§»
pub fn verify_state_transition(
    old_state: State<16>,
    new_state: State<16>,
    tx: Transaction,
) -> bool {
    // 1. æŸ¥æ‰¾å‘é€è€…å’Œæ¥æ”¶è€…
    // 2. éªŒè¯è´¦æˆ·å­˜åœ¨
    // 3. éªŒè¯å‘é€è€…çŠ¶æ€è½¬ç§»
    // 4. éªŒè¯æ¥æ”¶è€…çŠ¶æ€è½¬ç§»
    // 5. éªŒè¯å…¶ä»–è´¦æˆ·ä¸å˜
}

// åº”ç”¨äº¤æ˜“åˆ°çŠ¶æ€
pub fn apply_transaction(
    old_state: State<16>,
    tx: Transaction,
) -> State<16> {
    // è¿”å›åº”ç”¨äº¤æ˜“åçš„æ–°çŠ¶æ€
}

// åŒ…å« gas è´¹ç”¨çš„ç‰ˆæœ¬
pub fn verify_state_transition_with_gas(
    old_state: State<16>,
    new_state: State<16>,
    tx: Transaction,
    gas_used: u64,
    gas_price: Field,
) -> bool {
    // é¢å¤–éªŒè¯ gas è´¹ç”¨
}
```

### 4. RVF (Root Verification Function) - æ ¹éªŒè¯å‡½æ•°

**åŠŸèƒ½**ï¼šéªŒè¯ State_old å’Œ State_new ä¸é“¾ä¸ŠåŒºå—è®°å½•çš„çŠ¶æ€æ ¹ä¸€è‡´

**æ–‡ä»¶**ï¼š`zkcross/lib/src/rvf.nr`

**éªŒè¯é€»è¾‘**ï¼š
```noir
pub fn verify_root_cross_block(
    account_old: Account,
    proof_old: AccountProof,
    state_root_old: Hash,
    account_new: Account,
    proof_new: AccountProof,
    state_root_new: Hash,
) {
    // 1. éªŒè¯æ—§çŠ¶æ€ä¸æ—§åŒºå—çš„ state root ä¸€è‡´
    verify_account(account_old, proof_old, state_root_old);

    // 2. éªŒè¯æ–°çŠ¶æ€ä¸æ–°åŒºå—çš„ state root ä¸€è‡´
    verify_account(account_new, proof_new, state_root_new);
}
```

**æ³¨æ„**ï¼šRVF éœ€è¦è°ƒç”¨ä¸¤æ¬¡ `verify_account`ï¼Œç”±äº Noir çš„é™åˆ¶ï¼Œ
**å¿…é¡»ç”Ÿæˆä¸¤ä¸ªç‹¬ç«‹çš„ proof**ï¼ˆä¸èƒ½åœ¨ä¸€ä¸ªç”µè·¯ä¸­è°ƒç”¨ä¸¤æ¬¡ï¼‰ã€‚

## ğŸš€ å®Œæ•´åè®®æµç¨‹

```
åˆå§‹åŒ– (Initialize)
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Setup: ç”Ÿæˆ (pkÎ¨, vkÎ¨)        â”‚
â”‚ ä½¿ç”¨ç”µè·¯ Î›Î¨ å’Œå®‰å…¨å‚æ•° Î»       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
å®¡è®¡è¿‡ç¨‹ (For each transaction)
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. AF: æ£€æŸ¥å‘é€è€…åœ°å€           â”‚
â”‚    - æ˜¯å¦åœ¨é»‘åå•ä¸­ï¼Ÿ             â”‚
â”‚    - é€šè¿‡ï¼Ÿç»§ç»­                 â”‚
â”‚    - æ‹’ç»ï¼Ÿç»ˆæ­¢                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. SVF: éªŒè¯äº¤æ˜“ç­¾å             â”‚
â”‚    - ç­¾åæœ‰æ•ˆï¼Ÿç»§ç»­              â”‚
â”‚    - æ— æ•ˆï¼Ÿæ‹’ç»                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. STF: éªŒè¯çŠ¶æ€è½¬ç§»             â”‚
â”‚    - State_old â†’ State_new          â”‚
â”‚    - çŠ¶æ€è½¬ç§»æœ‰æ•ˆï¼Ÿç»§ç»­            â”‚
â”‚    - æ— æ•ˆï¼Ÿæ‹’ç»                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. RVF: éªŒè¯çŠ¶æ€æ ¹               â”‚
â”‚    - State_old åŒ¹é…åŒºå— I-2?       â”‚
â”‚    - State_new åŒ¹é…åŒºå— I-3?       â”‚
â”‚    - éƒ½åŒ¹é…ï¼Ÿç»§ç»­                â”‚
â”‚    - ä¸åŒ¹é…ï¼Ÿæ‹’ç»                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
è¯æ˜ç”Ÿæˆ (Proof Generation)
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä½¿ç”¨ pkÎ¨ ç”Ÿæˆ ZK-Proof           â”‚
â”‚ è¯æ˜æ‰€æœ‰éªŒè¯éƒ½é€šè¿‡                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
éªŒè¯ (Verification)
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä½¿ç”¨ vkÎ¨ éªŒè¯ ZK-Proof           â”‚
â”‚ è¯æ˜ï¼š                            â”‚
â”‚  - äº¤æ˜“å·²å®¡è®¡ (AF)                â”‚
â”‚  - ç­¾åæœ‰æ•ˆ (SVF)                â”‚
â”‚  - çŠ¶æ€è½¬ç§»æ­£ç¡® (STF)             â”‚
â”‚  - çŠ¶æ€æ ¹ä¸€è‡´ (RVF)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### TypeScript ä¸­çš„å®Œæ•´æµç¨‹

```typescript
// 1. Setup: ç”Ÿæˆå¯†é’¥å¯¹
const { pk, vk } = await setupZK();

// 2. è·å–åŒºå—æ•°æ®
const blockOld = await getBlock(I-2);
const blockNew = await getBlock(I-3);

// 3. è·å–è´¦æˆ· proof
const [proofOld, proofNew] = await Promise.all([
    getAccountProof(sender, blockOld),
    getAccountProof(sender, blockNew),
]);

// 4. AF: å®¡è®¡æ£€æŸ¥
const isBlacklisted = await checkBlacklist(sender);
if (isBlacklisted) {
    throw new Error('Address in blacklist');
}

// 5. SVF: ç­¾åéªŒè¯
const signatureValid = await verifySignature(tx, signature);
if (!signatureValid) {
    throw new Error('Invalid signature');
}

// 6. STF: çŠ¶æ€è½¬ç§»éªŒè¯
const stfValid = await verifyStateTransition(
    oldState,
    newState,
    tx
);
if (!stfValid) {
    throw new Error('Invalid state transition');
}

// 7. RVF: æ ¹éªŒè¯
const rvfValid = await verifyRootCrossBlock(
    proofOld,
    blockOld.stateRoot,
    proofNew,
    blockNew.stateRoot,
);
if (!rvfValid) {
    throw new Error('Invalid state root');
}

// 8. ç”Ÿæˆ ZK-Proof
const proof = await generateZKProof(pk, {
    afResult: !isBlacklisted,
    svfResult: signatureValid,
    stfResult: stfValid,
    rvfResult: rvfValid,
});

// 9. éªŒè¯ proof
const verified = await verifyZKProof(vk, proof);
console.log('âœ“ Proof verified:', verified);
```

## âš ï¸ é‡è¦é™åˆ¶å’Œæ³¨æ„äº‹é¡¹

### STF çš„é™åˆ¶

1. **å›ºå®šçŠ¶æ€å¤§å°**ï¼š
   - å½“å‰å®ç°æ”¯æŒ 16 ä¸ªè´¦æˆ·
   - è®ºæ–‡æåˆ°å¯ä»¥å‹ç¼©å¤šä¸ªåŒºå—çš„äº¤æ˜“

2. **Gas è´¹ç”¨**ï¼š
   - åŸºç¡€ç‰ˆæœ¬ä¸åŒ…å« gas
   - æä¾›äº† `verify_state_transition_with_gas` æ”¯æŒgas

3. **Noir é™åˆ¶**ï¼š
   - ä¸æ”¯æŒ `return` è¯­å¥ï¼ˆå·²å¤„ç†ï¼‰
   - Field æ¯”è¾ƒæœ‰é™åˆ¶ï¼ˆå·²å¤„ç†ï¼‰

### RVF çš„é™åˆ¶

1. **åŒé‡è°ƒç”¨é—®é¢˜**ï¼š
   - ä¸èƒ½åœ¨ä¸€ä¸ªç”µè·¯ä¸­è°ƒç”¨ä¸¤æ¬¡ `verify_account`
   - **å¿…é¡»ç”Ÿæˆä¸¤ä¸ªç‹¬ç«‹çš„ proof**

2. **è§£å†³æ–¹æ¡ˆ**ï¼š
   ```typescript
   // æ–¹æ¡ˆï¼šç”Ÿæˆä¸¤ä¸ªç‹¬ç«‹çš„ proof
   const proofOld = await verifyAccount(oldData);
   const proofNew = await verifyAccount(newData);
   // åˆ†åˆ«éªŒè¯ä¸¤ä¸ª proof
   ```

## ğŸ“Š æµ‹è¯•çŠ¶æ€

- âœ… STF éªŒè¯è§„åˆ™å·²å®ç°
- âœ… STF æ”¯æŒå¤šè´¦æˆ·çŠ¶æ€
- âœ… STF åŒ…å« gas è´¹ç”¨ç‰ˆæœ¬
- âœ… RVF åŒ proof æ–¹æ¡ˆå·²éªŒè¯
- âœ… åè®®æµç¨‹æµ‹è¯•é€šè¿‡

## ğŸ¯ ä¸‹ä¸€æ­¥

1. **å®ç° AF (Auditing Function)**
   - å®Œå–„é»‘åå•æ£€æŸ¥é€»è¾‘

2. **å®ç° SVF (Signature Verification Function)**
   - é›†æˆä»¥å¤ªåŠç­¾åéªŒè¯

3. **é›†æˆå®Œæ•´åè®®**
   - ç»„åˆ AF + SVF + STF + RVF
   - ç”Ÿæˆæœ€ç»ˆçš„ ZK-Proof

4. **ä¼˜åŒ– STF**
   - æ”¯æŒæ›´å¤šè´¦æˆ·
   - æ‰¹é‡å¤„ç†å¤šç¬”äº¤æ˜“

## ğŸ“š ç›¸å…³æ–‡ä»¶

- `zkcross/lib/src/stf_paper.nr` - STF è®ºæ–‡å®ç°
- `zkcross/lib/src/rvf.nr` - RVF å®ç°
- `zkcross/lib/src/af.nr` - AF å®ç°
- `zkcross/lib/src/svf.nr` - SVF å®ç°
- `zkcross/tests/zkcross-paper.test.ts` - åè®®æµ‹è¯•
